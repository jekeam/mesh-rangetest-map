<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Range Test Heatmap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #upload-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

    <div id="upload-container">
        <label for="csv-upload">Загрузить CSV Meshtastic Range Test:</label>
        <input type="file" id="csv-upload" accept=".csv" />
    </div>

    <div id="map"></div>

    <script>
        // === Инициализация карты ===
        const map = L.map('map').setView([40.75, -74], 13);

        // --- Базовые слои ---
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map); // <-- по умолчанию

        const darkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CartoDB</a> | Data: OpenStreetMap'
        });

        const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
        });

        const baseMaps = {
            "OpenStreetMap": osm,
            "CartoDB Dark Matter": darkMatter,
            "Esri WorldImagery": esri
        };

        L.control.layers(baseMaps).addTo(map);

        // === Обработчик загрузки ===
        document.getElementById('csv-upload').addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: results => processData(results.data)
                });
            } else {
                alert('Пожалуйста, загрузите корректный CSV-файл.');
            }
        }

        function processData(data) {
            const heatPoints = [];
            let bounds = L.latLngBounds();

            data.forEach(row => {
                const lat = parseFloat(row['rx lat']);
                const lon = parseFloat(row['rx long']);
                const snr = parseFloat(row['rx snr']);

                if (!isNaN(lat) && !isNaN(lon) && !isNaN(snr)) {
                    // Нормализация SNR в диапазон [0, 1]
                    const clipped = Math.max(-21, Math.min(12, snr));
                    const weight = (clipped - (-21)) / (12 - (-21));

                    heatPoints.push([lat, lon, weight]);
                    bounds.extend([lat, lon]);
                }
            });

            if (heatPoints.length === 0) {
                alert("В CSV нет корректных данных.");
                return;
            }

            // --- Очистка предыдущих слоёв ---
            if (window.currentHeatLayer) {
                map.removeLayer(window.currentHeatLayer);
            }

            // --- Создание тепловой карты ---
            window.currentHeatLayer = L.heatLayer(heatPoints, {
                radius: 20,
                blur: 25,
                minOpacity: 0.4,
                maxZoom: 12
            }).addTo(map);

            map.fitBounds(bounds);
        }
    </script>

</body>
</html>
